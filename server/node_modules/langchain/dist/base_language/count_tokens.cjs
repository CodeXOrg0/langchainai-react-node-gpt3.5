"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.calculateMaxTokens = exports.importTiktoken = exports.getModelContextSize = exports.getModelNameForTiktoken = void 0;
// https://www.npmjs.com/package/@dqbd/tiktoken
const getModelNameForTiktoken = (modelName) => {
    if (modelName.startsWith("gpt-3.5-turbo-")) {
        return "gpt-3.5-turbo";
    }
    if (modelName.startsWith("gpt-4-32k-")) {
        return "gpt-4-32k";
    }
    if (modelName.startsWith("gpt-4-")) {
        return "gpt-4";
    }
    return modelName;
};
exports.getModelNameForTiktoken = getModelNameForTiktoken;
const getModelContextSize = (modelName) => {
    switch ((0, exports.getModelNameForTiktoken)(modelName)) {
        case "text-davinci-003":
            return 4097;
        case "text-curie-001":
            return 2048;
        case "text-babbage-001":
            return 2048;
        case "text-ada-001":
            return 2048;
        case "code-davinci-002":
            return 8000;
        case "code-cushman-001":
            return 2048;
        default:
            return 4097;
    }
};
exports.getModelContextSize = getModelContextSize;
const importTiktoken = async () => {
    try {
        const { encoding_for_model } = await import("@dqbd/tiktoken");
        return { encoding_for_model };
    }
    catch (error) {
        console.log(error);
        throw new Error("Please install @dqbd/tiktoken as a dependency with, e.g. `yarn add @dqbd/tiktoken`");
    }
};
exports.importTiktoken = importTiktoken;
const calculateMaxTokens = async ({ prompt, modelName, }) => {
    const { encoding_for_model } = await (0, exports.importTiktoken)();
    const encoding = encoding_for_model((0, exports.getModelNameForTiktoken)(modelName));
    const tokenized = encoding.encode(prompt);
    const numTokens = tokenized.length;
    const maxTokens = (0, exports.getModelContextSize)(modelName);
    encoding.free();
    return maxTokens - numTokens;
};
exports.calculateMaxTokens = calculateMaxTokens;
//# sourceMappingURL=count_tokens.js.map